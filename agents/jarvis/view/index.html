<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jarvis Dashboard</title>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-primary: #09090b;
      --bg-secondary: #18181b;
      --bg-tertiary: #27272a;
      --bg-hover: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --border: #27272a;
      --border-light: #3f3f46;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-bg: rgba(99, 102, 241, 0.12);
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.12);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.12);
      --success: #10b981;
      --success-bg: rgba(16, 185, 129, 0.12);
      --blue: #3b82f6;
      --blue-bg: rgba(59, 130, 246, 0.12);
      --purple: #a855f7;
      --purple-bg: rgba(168, 85, 247, 0.12);
      --radius: 8px;
      --radius-lg: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.4);
      --transition: 150ms ease;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ========== Layout ========== */
    .app { height: 100vh; display: flex; flex-direction: column; }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      background: var(--bg-primary);
    }

    .header-left { display: flex; align-items: center; gap: 12px; }

    .avatar {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 700; color: white;
    }

    .header-info h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.01em; }
    .header-info p { font-size: 11px; color: var(--text-muted); }

    .header-actions { display: flex; gap: 6px; }

    /* ========== Buttons ========== */
    .btn {
      padding: 7px 14px; border-radius: var(--radius); border: none;
      cursor: pointer; font-size: 12px; font-weight: 500;
      transition: all var(--transition); display: inline-flex;
      align-items: center; gap: 5px; white-space: nowrap;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-sm { padding: 4px 10px; font-size: 11px; }

    /* ========== Stats Bar ========== */
    .stats-bar {
      padding: 12px 20px;
      display: flex; gap: 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      overflow-x: auto;
    }
    .stats-bar::-webkit-scrollbar { display: none; }

    .stat {
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-width: 100px;
      flex-shrink: 0;
    }
    .stat-value { font-size: 22px; font-weight: 700; letter-spacing: -0.02em; }
    .stat-label { font-size: 11px; color: var(--text-muted); margin-top: 1px; }

    /* ========== Tabs ========== */
    .nav {
      padding: 0 20px;
      display: flex; gap: 2px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--bg-primary);
    }

    .nav-item {
      padding: 10px 16px;
      font-size: 13px; font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--transition);
      display: flex; align-items: center; gap: 6px;
    }
    .nav-item:hover { color: var(--text-secondary); }
    .nav-item.active { color: var(--text-primary); border-bottom-color: var(--accent); }

    .nav-badge {
      background: var(--bg-tertiary);
      padding: 1px 7px; border-radius: 99px;
      font-size: 11px; font-weight: 600;
      color: var(--text-muted);
    }
    .nav-item.active .nav-badge { background: var(--accent-bg); color: var(--accent); }

    /* ========== Toolbar ========== */
    .toolbar {
      padding: 10px 20px;
      display: flex; gap: 8px; align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .select {
      padding: 6px 10px; border-radius: var(--radius);
      background: var(--bg-secondary); border: 1px solid var(--border);
      color: var(--text-primary); font-size: 12px;
      cursor: pointer;
    }
    .select:focus { outline: none; border-color: var(--accent); }

    .search-input {
      padding: 6px 10px; border-radius: var(--radius);
      background: var(--bg-secondary); border: 1px solid var(--border);
      color: var(--text-primary); font-size: 12px;
      flex: 1; max-width: 240px;
    }
    .search-input:focus { outline: none; border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-muted); }

    /* ========== Content ========== */
    .content { flex: 1; overflow-y: auto; }
    .content::-webkit-scrollbar { width: 6px; }
    .content::-webkit-scrollbar-track { background: transparent; }
    .content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .content::-webkit-scrollbar-thumb:hover { background: var(--bg-hover); }

    .pad { padding: 16px 20px; }

    /* ========== Todo Items ========== */
    .todo-list { display: flex; flex-direction: column; gap: 6px; }

    .todo-card {
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
    }
    .todo-card:hover { border-color: var(--border-light); background: #1c1c1f; }
    .todo-card.overdue { border-left: 3px solid var(--danger); }
    .todo-card.high { border-left: 3px solid var(--danger); }
    .todo-card.medium { border-left: 3px solid var(--warning); }
    .todo-card.low { border-left: 3px solid var(--success); }

    .todo-row { display: flex; align-items: flex-start; gap: 10px; }

    .todo-icon {
      width: 20px; height: 20px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; margin-top: 1px;
    }

    .todo-body { flex: 1; min-width: 0; }

    .todo-title-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .todo-title {
      font-size: 13px; font-weight: 500; color: var(--text-primary);
      overflow: hidden; text-overflow: ellipsis;
    }
    .todo-title.done { text-decoration: line-through; opacity: 0.5; }

    .todo-id { font-size: 10px; color: var(--text-muted); font-family: monospace; }

    .todo-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-left: auto; flex-shrink: 0; }

    .badge {
      padding: 2px 7px; border-radius: 99px;
      font-size: 10px; font-weight: 600; letter-spacing: 0.02em;
      white-space: nowrap;
    }
    .badge-high { background: var(--danger-bg); color: #f87171; }
    .badge-medium { background: var(--warning-bg); color: #fbbf24; }
    .badge-low { background: var(--success-bg); color: #34d399; }
    .badge-draft { background: var(--purple-bg); color: #c084fc; }
    .badge-pending { background: var(--warning-bg); color: #fbbf24; }
    .badge-in_progress { background: var(--blue-bg); color: #60a5fa; }
    .badge-waiting_confirmation { background: var(--purple-bg); color: #c084fc; }
    .badge-completed { background: var(--success-bg); color: #34d399; }
    .badge-cancelled { background: var(--bg-tertiary); color: var(--text-muted); }
    .badge-personal { background: var(--blue-bg); color: #60a5fa; }
    .badge-delegated { background: var(--accent-bg); color: var(--accent-hover); }
    .badge-mixed { background: var(--purple-bg); color: #c084fc; }
    .badge-overdue { background: var(--danger-bg); color: #f87171; }

    .todo-desc {
      font-size: 12px; color: var(--text-secondary);
      margin-top: 4px; line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }

    .todo-meta-row {
      display: flex; gap: 12px; margin-top: 8px;
      font-size: 11px; color: var(--text-muted);
      flex-wrap: wrap; align-items: center;
    }
    .todo-meta-row span { display: flex; align-items: center; gap: 3px; }

    .todo-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .tag {
      padding: 1px 6px; background: var(--bg-tertiary); border-radius: 4px;
      font-size: 10px; color: var(--text-muted);
    }

    /* ========== Todo Detail Panel ========== */
    .detail-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      display: flex; justify-content: flex-end;
    }

    .detail-panel {
      width: 520px; max-width: 100%;
      background: var(--bg-primary);
      border-left: 1px solid var(--border);
      height: 100%; overflow-y: auto;
      animation: slideIn 0.2s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .detail-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; background: var(--bg-primary); z-index: 1;
    }

    .detail-body { padding: 20px; }

    .detail-section { margin-bottom: 20px; }
    .detail-section-title {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .detail-field { margin-bottom: 12px; }
    .detail-label { font-size: 11px; color: var(--text-muted); margin-bottom: 3px; }
    .detail-value { font-size: 13px; color: var(--text-primary); }

    .progress-log {
      max-height: 300px; overflow-y: auto;
      border: 1px solid var(--border); border-radius: var(--radius);
    }
    .progress-entry {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    .progress-entry:last-child { border-bottom: none; }
    .progress-time { font-size: 10px; color: var(--text-muted); margin-bottom: 2px; font-family: monospace; }
    .progress-content { color: var(--text-secondary); line-height: 1.5; word-break: break-word; }

    /* ========== Journal Items ========== */
    .journal-list { display: flex; flex-direction: column; gap: 6px; }

    .journal-card {
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition);
    }
    .journal-card:hover { border-color: var(--border-light); background: #1c1c1f; }

    .journal-date { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
    .journal-preview {
      font-size: 12px; color: var(--text-secondary);
      display: -webkit-box; -webkit-line-clamp: 2;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .journal-size { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

    /* ========== Journal Viewer ========== */
    .journal-viewer {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 12px; line-height: 1.8;
      white-space: pre-wrap; word-break: break-word;
      max-height: 60vh; overflow-y: auto;
      color: var(--text-secondary);
    }

    /* ========== Memory Items ========== */
    .memory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px;
    }

    .memory-card {
      padding: 14px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all var(--transition);
    }
    .memory-card:hover { border-color: var(--border-light); background: #1c1c1f; }

    .memory-cat {
      font-size: 10px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.05em;
      color: var(--accent); margin-bottom: 4px;
    }
    .memory-filename { font-size: 13px; font-weight: 500; margin-bottom: 4px; }
    .memory-preview {
      font-size: 11px; color: var(--text-secondary); line-height: 1.5;
      display: -webkit-box; -webkit-line-clamp: 3;
      -webkit-box-orient: vertical; overflow: hidden;
    }
    .memory-meta { font-size: 10px; color: var(--text-muted); margin-top: 6px; }

    .memory-category-tabs {
      display: flex; gap: 4px; flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .cat-tab {
      padding: 4px 10px; border-radius: 99px;
      font-size: 11px; font-weight: 500;
      background: var(--bg-secondary); border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      transition: all var(--transition);
    }
    .cat-tab:hover { border-color: var(--border-light); color: var(--text-secondary); }
    .cat-tab.active { background: var(--accent-bg); border-color: var(--accent); color: var(--accent); }

    /* ========== Form / Modal ========== */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex; align-items: center; justify-content: center;
      z-index: 200;
    }

    .modal {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 90%; max-width: 520px;
      max-height: 85vh; overflow-y: auto;
      padding: 24px;
      animation: fadeIn 0.15s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 16px; font-weight: 600; }

    .close-btn {
      background: none; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 20px; padding: 4px;
      border-radius: 6px; transition: all var(--transition);
    }
    .close-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }

    .form-group { margin-bottom: 14px; }
    .form-label {
      display: block; font-size: 12px; font-weight: 500;
      color: var(--text-secondary); margin-bottom: 5px;
    }
    .form-input, .form-textarea {
      width: 100%; padding: 8px 12px;
      background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: var(--radius); color: var(--text-primary);
      font-size: 13px; font-family: inherit;
    }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
    .form-textarea { resize: vertical; min-height: 60px; }

    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .form-actions {
      display: flex; justify-content: flex-end; gap: 8px;
      margin-top: 20px; padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ========== Empty & Loading ========== */
    .empty { text-align: center; padding: 48px 20px; color: var(--text-muted); }
    .empty-icon { font-size: 36px; margin-bottom: 8px; opacity: 0.5; }
    .empty-text { font-size: 13px; }

    .loading { text-align: center; padding: 32px; color: var(--text-muted); font-size: 13px; }

    .error-box {
      padding: 12px 16px; margin: 16px 20px;
      background: var(--danger-bg); border: 1px solid rgba(239,68,68,0.3);
      border-radius: var(--radius); color: #fca5a5; font-size: 12px;
    }

    /* ========== Responsive ========== */
    @media (max-width: 600px) {
      .stat { min-width: 80px; padding: 8px 10px; }
      .stat-value { font-size: 18px; }
      .detail-panel { width: 100%; }
      .memory-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
  (function() {
    'use strict';

    // ========================================================================
    // State
    // ========================================================================
    const S = {
      todos: [], journals: [], memoryItems: [], stats: {},
      tab: 'todos', // todos | journals | memory
      filterStatus: 'active', filterPriority: '', filterType: '', searchQuery: '',
      memoryCat: '',
      loading: true, error: null,
      showCreate: false, showDetail: false, detailTodo: null,
      showJournal: false, viewingJournal: null, journalLoading: false,
      showMemory: false, viewingMemory: null, memoryLoading: false,
    };

    // ========================================================================
    // API
    // ========================================================================
    function apiBase() {
      return '/api/agents/' + (window.LAVS_AGENT_ID || 'jarvis') + '/lavs';
    }

    async function call(endpoint, input) {
      const pp = window.LAVS_PROJECT_PATH || '';
      const h = { 'Content-Type': 'application/json' };
      const t = localStorage.getItem('jwt') || localStorage.getItem('auth_token') || '';
      if (t) h['Authorization'] = 'Bearer ' + t;
      if (pp) h['X-Project-Path'] = pp;
      const r = await fetch(apiBase() + '/' + endpoint, {
        method: 'POST', headers: h, body: JSON.stringify(input || {}),
      });
      if (!r.ok) throw new Error('API Error: ' + r.status);
      const d = await r.json();
      return d.result !== undefined ? d.result : d;
    }

    // ========================================================================
    // Data Loading
    // ========================================================================
    async function loadAll() {
      S.loading = true; S.error = null; render();
      try {
        const [todos, stats, journals] = await Promise.all([
          call('listTodos', {}),
          call('getStats', {}),
          call('listJournals', { limit: 30 }),
        ]);
        S.todos = Array.isArray(todos) ? todos : [];
        S.stats = stats || {};
        S.journals = Array.isArray(journals) ? journals : [];
        S.loading = false;
      } catch(e) {
        S.error = e.message; S.loading = false;
      }
      render();
    }

    async function loadMemory(cat) {
      try {
        const items = await call('listMemory', cat ? { category: cat } : {});
        S.memoryItems = Array.isArray(items) ? items : [];
      } catch(e) {
        S.memoryItems = [];
      }
      render();
    }

    // ========================================================================
    // Actions
    // ========================================================================
    async function createTodo(data) {
      try {
        await call('addTodo', data);
        S.showCreate = false;
        await loadAll();
      } catch(e) { S.error = e.message; render(); }
    }

    async function doUpdateTodo(id, updates) {
      try {
        await call('updateTodo', { id, updates });
        S.showDetail = false; S.detailTodo = null;
        await loadAll();
      } catch(e) { S.error = e.message; render(); }
    }

    async function doDeleteTodo(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¾…åŠå—ï¼Ÿ')) return;
      try {
        await call('deleteTodo', { id });
        S.showDetail = false; S.detailTodo = null;
        await loadAll();
      } catch(e) { S.error = e.message; render(); }
    }

    async function doArchiveTodo(id) {
      if (!confirm('ç¡®å®šè¦å½’æ¡£è¿™ä¸ªå¾…åŠå—ï¼Ÿ')) return;
      try {
        await call('archiveTodo', { id });
        S.showDetail = false; S.detailTodo = null;
        await loadAll();
      } catch(e) { S.error = e.message; render(); }
    }

    async function openJournal(date) {
      S.journalLoading = true; S.viewingJournal = { date, content: '', exists: false };
      S.showJournal = true; render();
      try {
        const r = await call('getJournal', { date });
        S.viewingJournal = r; S.journalLoading = false;
      } catch(e) { S.error = e.message; S.journalLoading = false; }
      render();
    }

    async function openMemoryFile(cat, filename) {
      S.memoryLoading = true; S.viewingMemory = { category: cat, filename, content: '', exists: false };
      S.showMemory = true; render();
      try {
        const r = await call('getMemory', { category: cat, filename });
        S.viewingMemory = r; S.memoryLoading = false;
      } catch(e) { S.error = e.message; S.memoryLoading = false; }
      render();
    }

    // ========================================================================
    // Helpers
    // ========================================================================
    function esc(t) { if (!t) return ''; return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function isOverdue(t) {
      if (!t.deadline || t.status === 'completed' || t.status === 'cancelled') return false;
      return new Date(t.deadline) < new Date();
    }

    function relativeTime(d) {
      if (!d) return '';
      const now = new Date(), then = new Date(d);
      const diff = now - then;
      if (diff < 0) {
        const m = Math.round(-diff / 60000);
        if (m < 60) return m + 'åˆ†é’Ÿå';
        const h = Math.round(m / 60);
        if (h < 24) return h + 'å°æ—¶å';
        return Math.round(h / 24) + 'å¤©å';
      }
      const m = Math.round(diff / 60000);
      if (m < 60) return m + 'åˆ†é’Ÿå‰';
      const h = Math.round(m / 60);
      if (h < 24) return h + 'å°æ—¶å‰';
      return Math.round(h / 24) + 'å¤©å‰';
    }

    function formatDate(d) {
      if (!d) return '';
      try { return new Date(d).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }
      catch(e) { return d; }
    }

    function formatSize(b) {
      if (b < 1024) return b + 'B';
      if (b < 1024*1024) return (b/1024).toFixed(1) + 'KB';
      return (b/1024/1024).toFixed(1) + 'MB';
    }

    function statusLabel(s) {
      const m = { draft:'è‰ç¨¿', pending:'å¾…å¤„ç†', in_progress:'è¿›è¡Œä¸­', completed:'å·²å®Œæˆ', cancelled:'å·²å–æ¶ˆ', waiting_confirmation:'å¾…ç¡®è®¤' };
      return m[s] || s;
    }

    function typeIcon(t) {
      return t === 'personal' ? 'ğŸ‘¤' : t === 'delegated' ? 'ğŸ¤–' : 'ğŸ‘¥';
    }

    function filteredTodos() {
      let list = S.todos;
      if (S.filterStatus === 'active') {
        list = list.filter(t => t.status === 'pending' || t.status === 'in_progress' || t.status === 'draft' || t.status === 'waiting_confirmation');
      } else if (S.filterStatus) {
        list = list.filter(t => t.status === S.filterStatus);
      }
      if (S.filterPriority) list = list.filter(t => t.priority === S.filterPriority);
      if (S.filterType) list = list.filter(t => t.type === S.filterType);
      if (S.searchQuery) {
        const q = S.searchQuery.toLowerCase();
        list = list.filter(t =>
          (t.title && t.title.toLowerCase().includes(q)) ||
          (t.description && t.description.toLowerCase().includes(q)) ||
          (t.tags && t.tags.some(tag => tag.toLowerCase().includes(q)))
        );
      }
      // Sort: overdue first, then by priority (high > medium > low), then by updatedAt
      const pOrder = { high: 0, medium: 1, low: 2 };
      list.sort((a, b) => {
        const aOd = isOverdue(a) ? 0 : 1;
        const bOd = isOverdue(b) ? 0 : 1;
        if (aOd !== bOd) return aOd - bOd;
        const ap = pOrder[a.priority] !== undefined ? pOrder[a.priority] : 1;
        const bp = pOrder[b.priority] !== undefined ? pOrder[b.priority] : 1;
        if (ap !== bp) return ap - bp;
        return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
      });
      return list;
    }

    // ========================================================================
    // Render Engine
    // ========================================================================
    function render() {
      const root = document.getElementById('root');
      let h = '<div class="app">';

      // Header
      h += '<div class="header">';
      h += '<div class="header-left">';
      h += '<div class="avatar">J</div>';
      h += '<div class="header-info"><h1>Jarvis</h1><p>Personal AI Secretary</p></div>';
      h += '</div>';
      h += '<div class="header-actions">';
      if (S.tab === 'todos') h += '<button class="btn btn-primary" data-act="create">+ æ–°å»º</button>';
      h += '<button class="btn btn-ghost" data-act="refresh">â†»</button>';
      h += '</div></div>';

      // Stats bar
      h += '<div class="stats-bar">';
      h += statCard(S.stats.total || 0, 'æ€»è®¡', 'var(--text-primary)');
      h += statCard(S.stats.pending || 0, 'å¾…å¤„ç†', 'var(--warning)');
      h += statCard(S.stats.in_progress || 0, 'è¿›è¡Œä¸­', 'var(--blue)');
      h += statCard(S.stats.draft || 0, 'è‰ç¨¿', 'var(--purple)');
      h += statCard(S.stats.overdue || 0, 'å·²è¿‡æœŸ', 'var(--danger)');
      h += statCard(S.stats.completed || 0, 'å·²å®Œæˆ', 'var(--success)');
      h += '</div>';

      // Nav
      h += '<div class="nav">';
      h += navItem('todos', 'å¾…åŠäº‹é¡¹', S.todos.length);
      h += navItem('journals', 'æ—¥å¿—', S.journals.length);
      h += navItem('memory', 'è®°å¿†ç³»ç»Ÿ', S.memoryItems.length);
      h += '</div>';

      // Error
      if (S.error) h += '<div class="error-box">' + esc(S.error) + ' <span style="cursor:pointer;float:right" data-act="dismiss-error">âœ•</span></div>';

      // Content
      h += '<div class="content">';
      if (S.loading) {
        h += '<div class="loading">åŠ è½½ä¸­...</div>';
      } else if (S.tab === 'todos') {
        h += renderTodosTab();
      } else if (S.tab === 'journals') {
        h += renderJournalsTab();
      } else if (S.tab === 'memory') {
        h += renderMemoryTab();
      }
      h += '</div>';

      h += '</div>'; // .app

      // Modals / Panels
      if (S.showCreate) h += renderCreateModal();
      if (S.showDetail && S.detailTodo) h += renderDetailPanel();
      if (S.showJournal) h += renderJournalModal();
      if (S.showMemory) h += renderMemoryModal();

      root.innerHTML = h;
      bindEvents();
    }

    function statCard(val, label, color) {
      return '<div class="stat"><div class="stat-value" style="color:' + color + '">' + val + '</div><div class="stat-label">' + label + '</div></div>';
    }

    function navItem(id, label, count) {
      return '<div class="nav-item' + (S.tab === id ? ' active' : '') + '" data-tab="' + id + '">' +
        label + '<span class="nav-badge">' + (count || 0) + '</span></div>';
    }

    // ========================================================================
    // Todos Tab
    // ========================================================================
    function renderTodosTab() {
      let h = '<div class="toolbar">';
      h += sel('filter-status', S.filterStatus, [
        ['active', 'ğŸ“‹ æ´»è·ƒ'], ['', 'å…¨éƒ¨'], ['draft', 'ğŸ“ è‰ç¨¿'], ['pending', 'â³ å¾…å¤„ç†'],
        ['in_progress', 'ğŸ”„ è¿›è¡Œä¸­'], ['waiting_confirmation', 'â° å¾…ç¡®è®¤'], ['completed', 'âœ… å·²å®Œæˆ']
      ]);
      h += sel('filter-priority', S.filterPriority, [
        ['', 'å…¨éƒ¨ä¼˜å…ˆçº§'], ['high', 'ğŸ”´ é«˜'], ['medium', 'ğŸŸ¡ ä¸­'], ['low', 'ğŸŸ¢ ä½']
      ]);
      h += sel('filter-type', S.filterType, [
        ['', 'å…¨éƒ¨ç±»å‹'], ['personal', 'ğŸ‘¤ ä¸ªäºº'], ['delegated', 'ğŸ¤– å§”æ´¾'], ['mixed', 'ğŸ‘¥ æ··åˆ']
      ]);
      h += '<input class="search-input" id="search-input" placeholder="æœç´¢..." value="' + esc(S.searchQuery) + '">';
      h += '</div>';

      const todos = filteredTodos();
      h += '<div class="pad">';
      if (todos.length === 0) {
        h += '<div class="empty"><div class="empty-icon">ğŸ“‹</div><div class="empty-text">æš‚æ— åŒ¹é…çš„å¾…åŠäº‹é¡¹</div></div>';
      } else {
        h += '<div class="todo-list">';
        for (const t of todos) h += renderTodoCard(t);
        h += '</div>';
      }
      h += '</div>';
      return h;
    }

    function renderTodoCard(t) {
      const od = isOverdue(t);
      const pClass = t.priority || 'medium';
      let h = '<div class="todo-card ' + (od ? 'overdue' : pClass) + '" data-todo="' + esc(t.id) + '">';
      h += '<div class="todo-row">';
      h += '<div class="todo-icon">' + typeIcon(t.type) + '</div>';
      h += '<div class="todo-body">';
      h += '<div class="todo-title-row">';
      h += '<span class="todo-title' + (t.status === 'completed' ? ' done' : '') + '">' + esc(t.title) + '</span>';
      h += '<span class="todo-id">' + esc(t.id) + '</span>';
      h += '<div class="todo-badges">';
      if (od) h += '<span class="badge badge-overdue">å·²è¿‡æœŸ</span>';
      h += '<span class="badge badge-' + t.priority + '">' + (t.priority === 'high' ? 'é«˜' : t.priority === 'medium' ? 'ä¸­' : 'ä½') + '</span>';
      h += '<span class="badge badge-' + t.status + '">' + statusLabel(t.status) + '</span>';
      h += '</div></div>';

      if (t.description) h += '<div class="todo-desc">' + esc(t.description) + '</div>';

      if (t.tags && t.tags.length) {
        h += '<div class="todo-tags">';
        for (const tag of t.tags) h += '<span class="tag">' + esc(tag) + '</span>';
        h += '</div>';
      }

      h += '<div class="todo-meta-row">';
      if (t.deadline) h += '<span>' + (od ? 'âš ï¸' : 'ğŸ“…') + ' ' + formatDate(t.deadline) + '</span>';
      if (t.assignedAgent) h += '<span>ğŸ¤– ' + esc(t.assignedAgent) + '</span>';
      if (t.updatedAt) h += '<span>æ›´æ–° ' + relativeTime(t.updatedAt) + '</span>';
      const logCount = t.notes && t.notes.progressLog ? t.notes.progressLog.length : 0;
      if (logCount > 0) h += '<span>ğŸ“ ' + logCount + 'æ¡æ—¥å¿—</span>';
      h += '</div>';

      h += '</div></div></div>';
      return h;
    }

    function sel(id, val, opts) {
      let h = '<select class="select" id="' + id + '">';
      for (const [v, l] of opts) h += '<option value="' + v + '"' + (val === v ? ' selected' : '') + '>' + l + '</option>';
      h += '</select>';
      return h;
    }

    // ========================================================================
    // Todo Detail Panel
    // ========================================================================
    function renderDetailPanel() {
      const t = S.detailTodo;
      let h = '<div class="detail-overlay" data-act="close-detail">';
      h += '<div class="detail-panel" onclick="event.stopPropagation()">';

      h += '<div class="detail-header">';
      h += '<span style="font-weight:600;font-size:14px">' + typeIcon(t.type) + ' ' + esc(t.title) + '</span>';
      h += '<button class="close-btn" data-act="close-detail">&times;</button>';
      h += '</div>';

      h += '<div class="detail-body">';

      // Status badges
      h += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px">';
      h += '<span class="badge badge-' + t.priority + '">' + (t.priority === 'high' ? 'ğŸ”´ é«˜ä¼˜å…ˆçº§' : t.priority === 'medium' ? 'ğŸŸ¡ ä¸­ä¼˜å…ˆçº§' : 'ğŸŸ¢ ä½ä¼˜å…ˆçº§') + '</span>';
      h += '<span class="badge badge-' + t.status + '">' + statusLabel(t.status) + '</span>';
      h += '<span class="badge badge-' + t.type + '">' + typeIcon(t.type) + ' ' + (t.type === 'personal' ? 'ä¸ªäºº' : t.type === 'delegated' ? 'å§”æ´¾' : 'æ··åˆ') + '</span>';
      if (isOverdue(t)) h += '<span class="badge badge-overdue">âš ï¸ å·²è¿‡æœŸ</span>';
      h += '</div>';

      // Description
      if (t.description) {
        h += '<div class="detail-section">';
        h += '<div class="detail-section-title">æè¿°</div>';
        h += '<div style="font-size:13px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap">' + esc(t.description) + '</div>';
        h += '</div>';
      }

      // Details grid
      h += '<div class="detail-section">';
      h += '<div class="detail-section-title">è¯¦ç»†ä¿¡æ¯</div>';
      h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">';
      h += field('ID', t.id);
      h += field('åˆ›å»ºæ—¶é—´', formatDate(t.createdAt));
      h += field('æ›´æ–°æ—¶é—´', formatDate(t.updatedAt));
      if (t.deadline) h += field('æˆªæ­¢æ—¶é—´', formatDate(t.deadline));
      if (t.scheduledTime) h += field('è®¡åˆ’æ—¶é—´', formatDate(t.scheduledTime));
      if (t.assignedAgent) h += field('å§”æ´¾ç»™', t.assignedAgent);
      if (t.agentProject) h += field('å…³è”é¡¹ç›®', t.agentProject);
      if (t.executionStrategy) h += field('æ‰§è¡Œç­–ç•¥', t.executionStrategy);
      h += '</div></div>';

      // Tags
      if (t.tags && t.tags.length) {
        h += '<div class="detail-section">';
        h += '<div class="detail-section-title">æ ‡ç­¾</div>';
        h += '<div style="display:flex;gap:4px;flex-wrap:wrap">';
        for (const tag of t.tags) h += '<span class="tag" style="font-size:12px;padding:3px 8px">' + esc(tag) + '</span>';
        h += '</div></div>';
      }

      // Progress log
      if (t.notes && t.notes.progressLog && t.notes.progressLog.length) {
        h += '<div class="detail-section">';
        h += '<div class="detail-section-title">è¿›åº¦æ—¥å¿— (' + t.notes.progressLog.length + ')</div>';
        h += '<div class="progress-log">';
        // Show latest first
        const logs = [...t.notes.progressLog].reverse();
        for (const log of logs) {
          h += '<div class="progress-entry">';
          h += '<div class="progress-time">' + esc(log.timestamp || '') + ' Â· ' + esc(log.by || '') + '</div>';
          let content = log.content || '';
          // Try to parse JSON content
          try {
            const parsed = JSON.parse(content);
            content = parsed.content || content;
          } catch(e) {}
          h += '<div class="progress-content">' + esc(content) + '</div>';
          h += '</div>';
        }
        h += '</div></div>';
      }

      // Actions
      h += '<div style="display:flex;gap:8px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">';
      h += '<button class="btn btn-danger btn-sm" data-act="delete-todo" data-id="' + esc(t.id) + '">åˆ é™¤</button>';
      h += '<button class="btn btn-ghost btn-sm" data-act="archive-todo" data-id="' + esc(t.id) + '">å½’æ¡£</button>';
      h += '<div style="flex:1"></div>';

      // Quick status buttons
      if (t.status !== 'in_progress') h += '<button class="btn btn-primary btn-sm" data-act="set-status" data-id="' + esc(t.id) + '" data-status="in_progress">å¼€å§‹</button>';
      if (t.status !== 'completed') h += '<button class="btn btn-sm" style="background:var(--success);color:white" data-act="set-status" data-id="' + esc(t.id) + '" data-status="completed">å®Œæˆ</button>';
      h += '</div>';

      h += '</div></div></div>';
      return h;
    }

    function field(label, value) {
      return '<div class="detail-field"><div class="detail-label">' + label + '</div><div class="detail-value">' + esc(value || '-') + '</div></div>';
    }

    // ========================================================================
    // Journals Tab
    // ========================================================================
    function renderJournalsTab() {
      let h = '<div class="pad">';
      if (S.journals.length === 0) {
        h += '<div class="empty"><div class="empty-icon">ğŸ“–</div><div class="empty-text">æš‚æ— æ—¥å¿—</div></div>';
      } else {
        h += '<div class="journal-list">';
        for (const j of S.journals) {
          h += '<div class="journal-card" data-journal="' + esc(j.date) + '">';
          h += '<div class="journal-date">ğŸ“… ' + esc(j.date) + '</div>';
          h += '<div class="journal-preview">' + esc(j.preview || '') + '</div>';
          if (j.size) h += '<div class="journal-size">' + formatSize(j.size) + '</div>';
          h += '</div>';
        }
        h += '</div>';
      }
      h += '</div>';
      return h;
    }

    function renderJournalModal() {
      const j = S.viewingJournal;
      if (!j) return '';
      let h = '<div class="modal-overlay" data-act="close-journal">';
      h += '<div class="modal" style="max-width:700px" onclick="event.stopPropagation()">';
      h += '<div class="modal-header">';
      h += '<div class="modal-title">ğŸ“… ' + esc(j.date) + '</div>';
      h += '<button class="close-btn" data-act="close-journal">&times;</button>';
      h += '</div>';
      if (S.journalLoading) {
        h += '<div class="loading">åŠ è½½ä¸­...</div>';
      } else if (!j.exists) {
        h += '<div class="empty"><div class="empty-text">è¯¥æ—¥æœŸæš‚æ— æ—¥å¿—</div></div>';
      } else {
        h += '<div class="journal-viewer">' + esc(j.content || '') + '</div>';
      }
      h += '</div></div>';
      return h;
    }

    // ========================================================================
    // Memory Tab
    // ========================================================================
    function renderMemoryTab() {
      // Category tabs
      const cats = [];
      const catSet = new Set();
      for (const m of S.memoryItems) { if (!catSet.has(m.category)) { catSet.add(m.category); cats.push(m.category); } }

      let h = '<div class="pad">';
      h += '<div class="memory-category-tabs">';
      h += '<div class="cat-tab' + (!S.memoryCat ? ' active' : '') + '" data-cat="">å…¨éƒ¨</div>';
      for (const c of cats) {
        h += '<div class="cat-tab' + (S.memoryCat === c ? ' active' : '') + '" data-cat="' + esc(c) + '">' + esc(c) + '</div>';
      }
      h += '</div>';

      const items = S.memoryCat ? S.memoryItems.filter(m => m.category === S.memoryCat) : S.memoryItems;

      if (items.length === 0) {
        h += '<div class="empty"><div class="empty-icon">ğŸ§ </div><div class="empty-text">æš‚æ— è®°å¿†æ•°æ®</div></div>';
      } else {
        h += '<div class="memory-grid">';
        for (const m of items) {
          h += '<div class="memory-card" data-mem-cat="' + esc(m.category) + '" data-mem-file="' + esc(m.filename) + '">';
          h += '<div class="memory-cat">' + esc(m.category) + '</div>';
          h += '<div class="memory-filename">' + esc(m.filename) + '</div>';
          h += '<div class="memory-preview">' + esc(m.preview || '') + '</div>';
          h += '<div class="memory-meta">' + formatSize(m.size || 0) + ' Â· æ›´æ–° ' + relativeTime(m.updatedAt) + '</div>';
          h += '</div>';
        }
        h += '</div>';
      }
      h += '</div>';
      return h;
    }

    function renderMemoryModal() {
      const m = S.viewingMemory;
      if (!m) return '';
      let h = '<div class="modal-overlay" data-act="close-memory">';
      h += '<div class="modal" style="max-width:700px" onclick="event.stopPropagation()">';
      h += '<div class="modal-header">';
      h += '<div class="modal-title">ğŸ§  ' + esc(m.category) + ' / ' + esc(m.filename) + '</div>';
      h += '<button class="close-btn" data-act="close-memory">&times;</button>';
      h += '</div>';
      if (S.memoryLoading) {
        h += '<div class="loading">åŠ è½½ä¸­...</div>';
      } else if (!m.exists) {
        h += '<div class="empty"><div class="empty-text">æ–‡ä»¶ä¸å­˜åœ¨</div></div>';
      } else {
        h += '<div class="journal-viewer">' + esc(m.content || '') + '</div>';
      }
      h += '</div></div>';
      return h;
    }

    // ========================================================================
    // Create Modal
    // ========================================================================
    function renderCreateModal() {
      let h = '<div class="modal-overlay" data-act="close-create">';
      h += '<div class="modal" onclick="event.stopPropagation()">';
      h += '<div class="modal-header"><div class="modal-title">æ–°å»ºå¾…åŠ</div><button class="close-btn" data-act="close-create">&times;</button></div>';
      h += '<form id="create-form">';
      h += fg('æ ‡é¢˜ *', '<input class="form-input" id="c-title" required placeholder="å¾…åŠæ ‡é¢˜">');
      h += fg('æè¿°', '<textarea class="form-textarea" id="c-desc" rows="2" placeholder="è¯¦ç»†æè¿°"></textarea>');
      h += '<div class="form-row">';
      h += fg('ç±»å‹', '<select class="form-input" id="c-type"><option value="personal">ğŸ‘¤ ä¸ªäºº</option><option value="delegated">ğŸ¤– å¯å§”æ´¾</option><option value="mixed">ğŸ‘¥ æ··åˆ</option></select>');
      h += fg('ä¼˜å…ˆçº§', '<select class="form-input" id="c-priority"><option value="high">ğŸ”´ é«˜</option><option value="medium" selected>ğŸŸ¡ ä¸­</option><option value="low">ğŸŸ¢ ä½</option></select>');
      h += '</div>';
      h += '<div class="form-row">';
      h += fg('å¼€å§‹æ—¶é—´', '<input class="form-input" id="c-scheduled" type="datetime-local">');
      h += fg('æˆªæ­¢æ—¶é—´', '<input class="form-input" id="c-deadline" type="datetime-local">');
      h += '</div>';
      h += fg('æ ‡ç­¾ (é€—å·åˆ†éš”)', '<input class="form-input" id="c-tags" placeholder="å·¥ä½œ, é‡è¦">');
      h += '<div class="form-actions">';
      h += '<button type="button" class="btn btn-ghost" data-act="close-create">å–æ¶ˆ</button>';
      h += '<button type="submit" class="btn btn-primary">åˆ›å»º</button>';
      h += '</div></form></div></div>';
      return h;
    }

    function fg(label, input) {
      return '<div class="form-group"><label class="form-label">' + label + '</label>' + input + '</div>';
    }

    // ========================================================================
    // Event Binding
    // ========================================================================
    function bindEvents() {
      // Delegated click handler
      document.getElementById('root').addEventListener('click', function(e) {
        const el = e.target.closest('[data-act]');
        if (el) {
          const act = el.getAttribute('data-act');
          if (act === 'create') { S.showCreate = true; render(); }
          else if (act === 'refresh') { loadAll(); if (S.tab === 'memory') loadMemory(S.memoryCat); }
          else if (act === 'close-create') { S.showCreate = false; render(); }
          else if (act === 'close-detail') { S.showDetail = false; S.detailTodo = null; render(); }
          else if (act === 'close-journal') { S.showJournal = false; S.viewingJournal = null; render(); }
          else if (act === 'close-memory') { S.showMemory = false; S.viewingMemory = null; render(); }
          else if (act === 'dismiss-error') { S.error = null; render(); }
          else if (act === 'delete-todo') { doDeleteTodo(el.getAttribute('data-id')); }
          else if (act === 'archive-todo') { doArchiveTodo(el.getAttribute('data-id')); }
          else if (act === 'set-status') {
            doUpdateTodo(el.getAttribute('data-id'), { status: el.getAttribute('data-status') });
          }
          return;
        }

        // Tab click
        const tabEl = e.target.closest('[data-tab]');
        if (tabEl) {
          S.tab = tabEl.getAttribute('data-tab');
          if (S.tab === 'memory' && S.memoryItems.length === 0) loadMemory('');
          render();
          return;
        }

        // Todo click
        const todoEl = e.target.closest('[data-todo]');
        if (todoEl && !e.target.closest('[data-act]')) {
          const id = todoEl.getAttribute('data-todo');
          const todo = S.todos.find(t => t.id === id);
          if (todo) { S.detailTodo = todo; S.showDetail = true; render(); }
          return;
        }

        // Journal click
        const jEl = e.target.closest('[data-journal]');
        if (jEl) {
          openJournal(jEl.getAttribute('data-journal'));
          return;
        }

        // Memory card click
        const mEl = e.target.closest('[data-mem-cat]');
        if (mEl) {
          openMemoryFile(mEl.getAttribute('data-mem-cat'), mEl.getAttribute('data-mem-file'));
          return;
        }

        // Memory category tab
        const catEl = e.target.closest('[data-cat]');
        if (catEl) {
          S.memoryCat = catEl.getAttribute('data-cat');
          render();
          return;
        }
      });

      // Filters
      ['filter-status', 'filter-priority', 'filter-type'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', function() {
          if (id === 'filter-status') S.filterStatus = this.value;
          if (id === 'filter-priority') S.filterPriority = this.value;
          if (id === 'filter-type') S.filterType = this.value;
          render();
        });
      });

      // Search
      const searchEl = document.getElementById('search-input');
      if (searchEl) {
        searchEl.addEventListener('input', function() {
          S.searchQuery = this.value;
          render();
          // Refocus after render
          const el = document.getElementById('search-input');
          if (el) { el.focus(); el.setSelectionRange(el.value.length, el.value.length); }
        });
      }

      // Create form
      const form = document.getElementById('create-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          const data = {
            title: document.getElementById('c-title').value,
            description: document.getElementById('c-desc').value,
            type: document.getElementById('c-type').value,
            priority: document.getElementById('c-priority').value,
            tags: document.getElementById('c-tags').value.split(',').map(t => t.trim()).filter(Boolean),
          };
          const scheduled = document.getElementById('c-scheduled').value;
          const deadline = document.getElementById('c-deadline').value;
          if (scheduled) data.scheduledTime = new Date(scheduled).toISOString();
          if (deadline) data.deadline = new Date(deadline).toISOString();
          createTodo(data);
        });
      }
    }

    // ========================================================================
    // Agent Action Listener (event-driven sync)
    // ========================================================================
    window.addEventListener('message', function(e) {
      if (e.data && e.data.type === 'lavs-agent-action') {
        console.log('[JarvisView] Agent action:', e.data.action);
        if (e.data.action && e.data.action.type === 'tool_executed') {
          if (e.data.action.tool && (e.data.action.tool.includes('__lavs_') || e.data.action.tool.includes('jarvis'))) {
            console.log('[JarvisView] Refreshing data after agent action...');
            loadAll();
            if (S.tab === 'memory') loadMemory(S.memoryCat);
          }
        }
      }
    });

    // ========================================================================
    // Init
    // ========================================================================
    document.addEventListener('DOMContentLoaded', function() {
      render();
      loadAll();
    });
  })();
  </script>
</body>
</html>
